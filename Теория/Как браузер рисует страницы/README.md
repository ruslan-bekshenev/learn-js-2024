# Как браузер рисует страницы



## Этапы

### Получение ресурсов, Fetching

Самый первый запрос к серверу - обычно запрос на получение html страницы

В ее коде содержатся ссылки на другие ресурсы, которые браузер тоже запросит у сервера

### Парсинг, Parsing

Скачивается html, браузер пытается его распарсить

### DOM

Document Object Model (DOM) - абстрактное представление HTML документа, с помощью которого браузер может получать доступ к его элементам, изменять структуру и оформление

DOM - это дерево, корень которого является элемент html, все остальные - дочерные узлы

Пока браузер парсит документ и строит DOM, он натыкается на другие 
элементы, такие как ``<img>``, ``<link>``, `<script>`, которые ведут на другие ресурсы.

Если ресурс не блокирующий (например, изображение), то браузер запрашивает его параллельно с парсингом оставшейся части документа. Блокирующие ресурсы (например скрипты) приостанавливает обработку до своей полной загрузки.


### CSSOM

Браузер находит элемент ``<link>``, который скачивает и парсит его. Результат парсинга CSS-кода - CSSOM

CSS Object Model (CSSOM) - представление стилевых правил в виде дерева.

Чтение стилей приостанавливает чтение кода страаницы. Поэтому рекомендуется в самом начале отдавать только критичные стили - которые есть на всех страницах и конкретно на этой.

Благодаря оптимизации стили могут не блокировать чтение HTML, но они точно блокируют выполнение JS, потому что в JS могут использоваться CSS-селекторы для выборки элементов.

### Render Tree

После того как браузер составил DOM и CSSOM, он объединяет их в общее дерево рендеринга

Термин **Render Tree** Используется движком Webkit, в других движках он может отличаться

В Render Tree попадают только видимые элементы. Элемент спрятанный через `display: none` в дерево не попадает.

### Вычисление позиции и размеров, Layout

После render tree браузер начинает расставлять элементы на странице

Чтобы понимать где какой элемент должен находиться и как он влияет на расположение других элементов, браузер рассчитывает размеры и положение каждого рекурсивно

Расчет начинается от корневого элемента дерева рендеринга, его размеры равны размеру вьюпорта. Далее браузер переходит поочередно к каждому из дочерних элементов.

Layout построен на поточной модели компоновки. Это значит, что если элементы не влияют на расположение и размеры других элементов, то их положение и размеры можно просчитать за один подход

#### Глобальный и инкрементальный Layout

Глобальный layout - процесс просчета всего дерева полностью, то есть каждого элемента. Инкрементальный - просчитывает только часть

Глобальный запускается при измении рамера окна, потому что браузеру требуется подогнать всю страницу под новыйц размер экрана.

Инкрементальный запускает пересчет только "грязных" элементов

#### "Грязные" элементы

Те элементы, которые были изменены, и их дочерние элементы.

Если мы изменили блок, то браузер перерисует его и его детей.

### Отрисовка, Paint

Во время отрисовки (Paint) браузер наполняет пиксели на экране нужными цветами в завимости от того, что в конкретном месте должно быть нарисовано: текст, изображение, цвет фота, тени, рамки и т.д.

Отрисовка тоже бывает глобальной и инкрементальной. Чтобы понять, какую часть вьюпорта надо перерисовать, браузер делит весь вьюпорт на прямоугольные участки. Если изменения ограничены одним участно, то пометится "грязным" и перерисуется лишь он.

Отрисовка - самый дорогой процесс из всех

#### Порядок отрисовка
 - `backround-color`;
 - `backround-image`;
 - `border`
 - `children`
 - `outline`

### CPU и композитинг 

И Layout и Paint работают за счет CPU, поэтому относительно медленные. Плавные анимации при таком раскладе невероятно дорогие

Для плавных анимаций предусмотрен композитинг (Compositing)

Композитинг - разделение содержимого страницы на "слои", которые браузер будет перерисовывать. Эти слои не зависят друг от друга,  из-за чего изменения элемента в одном слое не затрагивает элементы из других слоев.

Именно из-за разнесения элементов по разным композиционным слоям свойство `transform` не так сильно нагружает браузер. Поэтому чтобы анимации не тормозили, их рекомендуется делать с применением transform и opacity

Применение свойств, как `tranform` выносит элемент на отдельный композитный слой, где положение элемента не зависит от других и не влияет на них.

### Перерисовка, Reflow (relayout) и Repaint

Процесс отрисовки - циклический. Браузер перерисовывает экран каждый раз, когда на странице происходят какие-то изменения.

Если, например, в DOM-дереве добавился новый узел, или изменился текст, то браузер построит новое дерево рендеринга и запустит вычисление позиции и отрисовку заново.

Один цикл обновления - это animation frame